{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<body class="admin-users">
    <h1>Manage Users</h1>

    <!-- Search Form -->
    <form method="GET" action="/admin/users" class="search-form">
        <input type="text" name="search" placeholder="Search by username or email" value="{{ search_query or '' }}">
        <button type="submit">Search</button>
    </form>

    <!-- Accordion for Create User Form -->
    <div class="accordion">
        <button class="accordion-toggle" onclick="toggleAccordion()">➤ Create New User</button>
        <div class="accordion-content" id="create-user-form">
            <form method="POST" action="/api/admin/users" class="create-user-form">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>

                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>

                <label for="is_admin">Is Admin:</label>
                <input type="checkbox" id="is_admin" name="is_admin">

                <label for="model_permission">Model Permission:</label>
                <select id="model_permission" name="model_permission">
                    <option value="ai_only">AI Only</option>
                    <option value="human_only">Human Only</option>
                    <option value="both">Both</option>
                    <option value="none">None</option>
                </select>

                <button type="submit">Create User</button>
            </form>
        </div>
    </div>

    <!-- List of Users -->
    <h3>Existing Users</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Is Admin</th>
                <th>Is Active</th>
                <th>Model Permission</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>{{ "Yes" if user.is_admin else "No" }}</td>
                <td>{{ "Yes" if user.is_active else "No" }}</td>
                <td>{{ user.model_permission }}</td>
                <td>
                    <form method="POST" action="/api/admin/users/{{ user.id }}" style="display:inline;">
                        <input type="hidden" name="_method" value="PUT">
                        <button type="submit">Update</button>
                    </form>
                    <form method="POST" action="/api/admin/users/{{ user.id }}" style="display:inline;">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit">Block</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="pagination">
        {% if current_page > 1 %}
        <a href="?page={{ current_page - 1 }}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
        {% endif %}
        <span>Page {{ current_page }}</span>
        {% if total_users > current_page * 25 %}
        <a href="?page={{ current_page + 1 }}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
        {% endif %}
    </div>
</body>

<script>
    function toggleAccordion() {
        const form = document.getElementById('create-user-form');
        const toggleButton = document.querySelector('.accordion-toggle');
        if (form.style.display === 'block') {
            form.style.display = 'none';
            toggleButton.textContent = '➤ Create New User';
        } else {
            form.style.display = 'block';
            toggleButton.textContent = '▼ Create New User';
        }
    }
</script>
{% endblock %}