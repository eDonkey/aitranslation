{% extends "base.html" %}

{% block title %}Translator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Translation Service</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Your API Key</h5>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="apiKey" placeholder="Enter your API key">
                    <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
                </div>
            </div>
        </div>

        <!-- Translation Type Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Translation Type</h5>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="switchMode('ai')">AI Translation</button>
                    <button type="button" class="btn btn-outline-primary" onclick="switchMode('human')">Human Translation</button>
                </div>
            </div>
        </div>

        <!-- AI Translation Form -->
        <div id="aiTranslationForm" class="card">
            <div class="card-body">
                <h5 class="card-title">AI Translation</h5>
                <form id="translationForm">
                    <div class="mb-3">
                        <label for="aiText" class="form-label">Text to translate:</label>
                        <textarea class="form-control" id="aiText" rows="4" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="aiLanguage" class="form-label">Original Language:</label>
                        <select class="form-select" id="aiLanguage" required>
                            <option value="english">English</option>
                            <option value="spanish">Spanish</option>
                            <option value="portuguese">Portuguese</option>
                            <option value="french">French</option>
                            <option value="deutch">Deutch</option>
                            <option value="italian">Italian</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Translate with AI</button>
                </form>
            </div>
        </div>

        <!-- Human Translation Form -->
        <div id="humanTranslationForm" class="card" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">Submit Text for Human Translation</h5>
                <form id="humanForm">
                    <div class="mb-3">
                        <label for="humanText" class="form-label">Text to translate:</label>
                        <textarea class="form-control" id="humanText" rows="4" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="humanLanguage" class="form-label">Original Language:</label>
                        <select class="form-select" id="humanLanguage" required>
                            <option value="english">English</option>
                            <option value="spanish">Spanish</option>
                            <option value="portuguese">Portuguese</option>
                            <option value="french">French</option>
                            <option value="deutch">Deutch</option>
                            <option value="italian">Italian</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Submit for Human Translation</button>
                </form>
            </div>
        </div>

        <div id="results" class="card mt-4" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">Results</h5>
                <div id="translationsContainer"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const savedApiKey = localStorage.getItem('clientApiKey');
    if (savedApiKey) {
        document.getElementById('apiKey').value = savedApiKey;
    }

    document.getElementById('translationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await translate();
    });

    document.getElementById('humanForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitHumanTranslation();
    });
});

function saveApiKey() {
    const apiKey = document.getElementById('apiKey').value;
    localStorage.setItem('clientApiKey', apiKey);
}

function switchMode(mode) {
    const aiForm = document.getElementById('aiTranslationForm');
    const humanForm = document.getElementById('humanTranslationForm');
    const results = document.getElementById('results');
    const buttons = document.querySelectorAll('.btn-group .btn');

    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    if (mode === 'ai') {
        aiForm.style.display = 'block';
        humanForm.style.display = 'none';
    } else {
        aiForm.style.display = 'none';
        humanForm.style.display = 'block';
    }
    results.style.display = 'none';
}

async function translate() {
    const apiKey = localStorage.getItem('clientApiKey');
    if (!apiKey) {
        alert('Please enter and save your API key first');
        return;
    }

    const text = document.getElementById('aiText').value;
    const language = document.getElementById('aiLanguage').value;
    const resultsDiv = document.getElementById('results');
    const translationsContainer = document.getElementById('translationsContainer');

    try {
        const formData = new FormData();
        formData.append('text', text);
        formData.append('language', language);

        const response = await fetch('/translate-text/', {
            method: 'POST',
            headers: {
                'X-API-Key': apiKey
            },
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        translationsContainer.innerHTML = `
            <div class="alert alert-success">
                Translation completed successfully!
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Original (${data.original_language})</h6>
                    <p class="card-text">${data.original_text}</p>
                </div>
            </div>
        `;

        Object.entries(data.translations).forEach(([lang, translation]) => {
            translationsContainer.innerHTML += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">${lang.charAt(0).toUpperCase() + lang.slice(1)}</h6>
                        <p class="card-text">${translation}</p>
                    </div>
                </div>
            `;
        });

        resultsDiv.style.display = 'block';
    } catch (error) {
        translationsContainer.innerHTML = `
            <div class="alert alert-danger">
                Error: ${error.message}
            </div>
        `;
        resultsDiv.style.display = 'block';
    }
}

async function submitHumanTranslation() {
    const apiKey = localStorage.getItem('clientApiKey');
    if (!apiKey) {
        alert('Please enter and save your API key first');
        return;
    }

    const text = document.getElementById('humanText').value;
    const language = document.getElementById('humanLanguage').value;
    const resultsDiv = document.getElementById('results');
    const translationsContainer = document.getElementById('translationsContainer');

    try {
        const response = await fetch('/save-text/', {
            method: 'POST',
            headers: {
                'X-API-Key': apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                language: language
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        translationsContainer.innerHTML = `
            <div class="alert alert-success">
                <h4 class="alert-heading">Success!</h4>
                <p>Your text has been submitted for human translation.</p>
                <hr>
                <p class="mb-0">Reference ID: ${data.id}</p>
            </div>
        `;

        resultsDiv.style.display = 'block';
        document.getElementById('humanForm').reset();
    } catch (error) {
        translationsContainer.innerHTML = `
            <div class="alert alert-danger">
                Error: ${error.message}
            </div>
        `;
        resultsDiv.style.display = 'block';
    }
}
</script>
{% endblock %}
