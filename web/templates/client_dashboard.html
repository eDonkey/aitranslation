{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Translation Dashboard</h1>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Free Trial Translation Card -->
        <div class="col-xl-12 col-md-12 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Try AI Translation for Free!</h6>
                    <span class="badge badge-info">One-time trial</span>
                </div>
                <div class="card-body">
                    <form id="trialTranslationForm">
                        <div class="form-group">
                            <label for="trialSourceText">Text to Translate</label>
                            <textarea class="form-control" id="trialSourceText" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="trialSourceLanguage">Source Language</label>
                            <select class="form-control" id="trialSourceLanguage" required>
                                <option value="english">English</option>
                                <option value="spanish">Spanish</option>
                                <option value="portuguese">Portuguese</option>
                                <option value="french">French</option>
                                <option value="deutch">German</option>
                                <option value="italian">Italian</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Try Free Translation</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Translation Form Card -->
        <div class="col-xl-12 col-md-12 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">New Translation</h6>
                </div>
                <div class="card-body">
                    <form id="translationForm">
                        <div class="form-group">
                            <label for="sourceText">Text to Translate</label>
                            <textarea class="form-control" id="sourceText" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sourceLanguage">Source Language</label>
                            <select class="form-control" id="sourceLanguage" required>
                                <option value="english">English</option>
                                <option value="spanish">Spanish</option>
                                <option value="portuguese">Portuguese</option>
                                <option value="french">French</option>
                                <option value="deutch">German</option>
                                <option value="italian">Italian</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Translation</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recent Translations Card -->
        <div class="col-xl-12 col-md-12 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">My Recent Translations</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="translationsTable">
                            <thead>
                                <tr>
                                    <th>Original Text</th>
                                    <th>Language</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for translation in translations %}
                                <tr>
                                    <td>{{ translation.english or translation.spanish or translation.portuguese or translation.french or translation.deutch or translation.italian }}</td>
                                    <td>
                                        {% if translation.english %}English
                                        {% elif translation.spanish %}Spanish
                                        {% elif translation.portuguese %}Portuguese
                                        {% elif translation.french %}French
                                        {% elif translation.deutch %}German
                                        {% elif translation.italian %}Italian
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if translation.updated_at %}
                                        <span class="badge badge-success">Completed</span>
                                        {% else %}
                                        <span class="badge badge-warning">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ translation.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <button class="btn btn-info btn-sm view-translation" data-id="{{ translation.id }}">
                                            View
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Translation Details Modal -->
<div class="modal fade" id="translationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Translation Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="translationDetails"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    console.log("{{ user.api_key }}");
    $('#translationsTable').DataTable({
        order: [[3, 'desc']] // Sort by created_at by default
    });

    // Handle translation form submission
    $('#translationForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('text', $('#sourceText').val());
        formData.append('language', $('#sourceLanguage').val());
        
        $.ajax({
            url: '/translate-text/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-API-Key': '{{ user.api_key }}'
            },
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Translation submitted successfully',
                    icon: 'success'
                }).then(() => {
                    location.reload();
                });
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.detail || 'Error submitting translation',
                    icon: 'error'
                });
            }
        });
    });

    // Handle view translation button clicks
    $('.view-translation').on('click', function() {
        const translationId = $(this).data('id');
        console.log(translationId);
        $.ajax({
            url: `/get-translation/${translationId}`,
            method: 'GET',
            headers: {
                'X-API-Key': '{{ user.api_key }}'
            },
            success: function(translation) {
                let html = '<div class="translations-grid">';
                const languages = ['english', 'spanish', 'portuguese', 'french', 'deutch', 'italian'];
                
                languages.forEach(lang => {
                    if (translation[lang]) {
                        html += `
                            <div class="translation-item">
                                <h6 class="font-weight-bold">${lang.charAt(0).toUpperCase() + lang.slice(1)}</h6>
                                <p>${translation[lang]}</p>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                $('#translationDetails').html(html);
                $('#translationModal').modal('show');
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.detail || 'Error fetching translation',
                    icon: 'error'
                });
            }
        });
    });

    // Handle trial translation form submission
    $('#trialTranslationForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('text', $('#trialSourceText').val());
        formData.append('language', $('#trialSourceLanguage').val());
        
        $.ajax({
            url: '/translate-text/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-API-Key': 'trial-key'  // Use a special trial key that your backend can recognize
            },
            success: function(response) {
                let translationsHtml = '<div class="translations-grid">';
                
                // Add original text
                translationsHtml += `
                    <div class="translation-item">
                        <h6 class="font-weight-bold">Original (${$('#trialSourceLanguage').val()})</h6>
                        <p>${$('#trialSourceText').val()}</p>
                    </div>
                `;
                
                // Add translations
                Object.entries(response.translations).forEach(([lang, text]) => {
                    if (lang !== $('#trialSourceLanguage').val()) {
                        translationsHtml += `
                            <div class="translation-item">
                                <h6 class="font-weight-bold">${lang.charAt(0).toUpperCase() + lang.slice(1)}</h6>
                                <p>${text}</p>
                            </div>
                        `;
                    }
                });
                
                translationsHtml += '</div>';
                
                Swal.fire({
                    title: 'Translation Complete!',
                    html: translationsHtml,
                    icon: 'success',
                    width: '800px'
                });
                
                // Clear the form
                $('#trialSourceText').val('');
                $('#trialSourceLanguage').val('english');
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.detail || 'Error with trial translation',
                    icon: 'error'
                });
            }
        });
    });
});
</script>

<style>
.translations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.translation-item {
    background: #f8f9fc;
    padding: 1rem;
    border-radius: 0.35rem;
}
</style>
{% endblock %}
